"undefined"==typeof flect&&(flect={}),function(a){"use strict";function b(b){for(var c=0;c<b.length;c++){var d=b[c],e=h[d.name];e||(e=d.name),d.text=e,this[d.name]=d}a.extend(this,{fromName:function(a){for(var c=0;c<b.length;c++)if(b[c].name==a)return b[c];return null}})}function c(b){if(!b)return!1;var c=b.constructor.name;return c?"FormData"===c:!a.isPlainObject(b)}function d(b){return a.isNumeric(b.replace(/,/g,""))}function e(a,b){return a.baseUrl+"/"+a.contextUrl+b}function f(b,c){function d(){if(0===b.find("button").length){var d=c.top,e=c.left;"center"==d&&(d=(a(window).height()-c.height)/2),"center"==e&&(e=(a(window).width()-c.width)/2),b.empty().css({display:"none",position:"fixed",top:d,left:e,width:c.width,height:c.height,border:"solid 1px #000000","background-color":"#F0F0F0","text-align":"center","z-index":1e3}).append("<div style='margin:10px 0'><img src='"+c.baseUrl+"/assets/images/loading.gif'/></div><div style='margin:10px 0'><span>"+j.Prepared.text+"...</span></div><div style='margin-right:10px;text-align:right'><button class='btn btn-warning'>"+h.Cancel+"</button></div><form action='#' method='post'></form>")}l=b.find("span"),m=b.find("form"),n=b.find("button"),n.unbind("click")}function f(){b.show()}function g(){b.hide()}function i(a){l.text(a)}function k(a){m.attr("action",e(c,"/finish/"+a)).submit()}var l,m,n;d(),a.extend(this,{show:f,close:g,text:i,download:k,cancelButton:n})}function g(b,d,g){function h(){var b="excelReport-download-dialog",c=a("#"+b);0===c.length&&(c=a("<div/>"),c.attr("id",b),a("body").append(c)),r=new f(c,g),r.cancelButton.click(n)}function k(){return"upload"==g.contextUrl}function l(f,h){q=null,p=!1,s=h;var i={url:e(g,"/prepare"),type:"POST",data:f,success:function(a){var b=j.fromName(a.status);b==j.Error?g.error(a.msg):b==j.Prepared?(q=a.ticket,g.showLoading&&r.show(),setTimeout(m,5e3)):(console.log("Unknown data",a),g.error(JSON.stringify(a)))},error:function(a,b,c){g.error(b+", "+c)}};k()||(i.url+="/"+b+"/"+d),c(f)&&(i.processData=!1,i.contentType=!1),a.ajax(i)}function m(){q&&!p&&a.ajax({url:e(g,"/status/"+q),type:"GET",success:function(a){var b=j.fromName(a.status);b==j.Prepared||b==j.Processing?(r.text(b.text+"..."),setTimeout(m,1e3)):b==j.Finished?(r.close(),k()?o():r.download(q)):b==j.Error?(r.close(),g.error(a.msg)):b==j.Canceled?r.close():(console.log("Unknown data",a),g.error(JSON.stringify(a)))},error:function(a,b,c){g.error(b+", "+c)}})}function n(){q&&!p&&(p=!0,a.ajax({url:e(g,"/cancel/"+q),type:"GET",success:function(a){console.log("Cancel: "+a)},error:function(a,b,c){g.error(b+", "+c)}}),r.close())}function o(){q&&!p&&a.ajax({url:e(g,"/finish/"+q),type:"GET",success:function(a){s&&s(a)},error:function(a,b,c){g.error(b+", "+c)}})}g=a.extend(i,g||{});var p=!1,q=null,r=null,s=null;h(),a.extend(this,{prepare:l})}var h={Prepared:"Preparing",Processing:"Processing",Finished:"Finished",Error:"Error",Canceled:"Canceled",Cancel:"Cancel"},i={baseUrl:"",contextUrl:"download",showLoading:!0,width:320,height:120,top:"center",left:"center",error:function(a){alert(a)}};flect.excelreport&&flect.excelreport.MSG&&(h=a.extend(h,flect.excelreport.MSG));var j=new b([{name:"Prepared"},{name:"Processing"},{name:"Finished"},{name:"Error"},{name:"Canceled"}]);flect.ExcelReport=function(b,e){function f(a){var b=a.attr("data-name"),c=a.prev("div:eq(0)"),d=a.next("div:eq(0)");return c.attr("data-name")==b||d.attr("data-name")==b}function h(a,c){var d=a||{};return d.baseUrl=b,d.contextUrl=c,d}function j(b,c){function d(b){var c=a("<span style='display:none;'/>"),d=0;return c.text(b.text()),b.parent().append(c),d=c.width(),c.remove(),d}b.find(".namedCell").each(function(){var b=a(this),e=b.find("span"),g=(b.attr("id"),e.text()),h=!!b.attr("data-formula");if(!h){var i=c?c(b):null,j=b.innerHeight(),k=b.innerWidth();if(null===i&&(i=a(j>40?"<textarea></textarea>":"<input type='text'/>")),"string"!=typeof i){if(g&&!f(b)){var l=d(e);k-=l+4,i.css("margin-left",l+8+"px")}else e.remove();i.css({width:k-8+"px",height:j-2+"px"}),i.addClass("cellInput"),i.attr("name",b.attr("data-name"))}b.append(i)}})}function k(c,f){function g(){var a="";return b?0===b.indexOf("https:")?a="wss"+b.substring(5):0===b.indexOf("http:")?a="ws"+b.substring(4):0===b.indexOf("//")?a=("https:"==location.protocol?"wss":"ws")+":"+b:i.error("Invalid baseUrl: "+b):a=("https:"==location.protocol?"wss":"ws")+"://"+location.host,a+"/liveform/"+e+"/"+f}var h=g(),j=new room.Connection(h);j.on("calced",function(b){a.each(b,function(b,c){var e=a("#"+b+" span");e.empty().append(c),d(c)&&!e.hasClass("cell-ac")&&e.removeClass("cell-al").addClass("cell-ar")})}),j.on("chart",function(b){if(a.fn.excelToChart){var d=b.chart,e=c.find(".excel-chart").eq(b.index);e.excelToChart(d),e.css("position","absolute")}}),j.sendNoop(30,!room.utils.isMobile()),c.find(":input").change(function(){var b=a(this),c=b.parent("div"),d=c.attr("id"),e=b.val();j.request({command:"modified",data:{id:d,value:e}})}),a.data(c.get(0),"connection",j)}function l(a,b,c){var d=new g(e,a,h(c,"download"));d.prepare(b)}function m(a,b,c){c=h(c,"pdf");var d=new g(e,a,c);d.prepare(b)}function n(b,c,d){switch(arguments.length){case 0:throw new Exception("upload file is required.");case 1:break;case 2:a.isFunction(arguments[1])&&(d=c,c=null)}c=h(c,"upload");var e=new g("","",c);e.prepare(b,d)}function o(d,f,g,h){var i={url:b+"/report/json/"+e+"/"+f,type:"POST",data:g,success:function(a,b,c){var e=c.getResponseHeader("content-type")||"json";-1!=e.indexOf("json")?(d.excelToCanvas(a),h.form&&j(d,h.buildInput),h.live&&WebSocket&&room&&room.Connection&&k(d,f),h.callback&&h.callback(d,a)):-1!=e.indexOf("html")&&d.html(a)}},l=a.data(d.get(0),"connection");l&&(l.close(),a.removeData(d.get(0),"connection")),c(g)&&(i.processData=!1,i.contentType=!1),a.ajax(i)}switch(arguments.length){case 0:options.error("user is required.");break;case 1:e=b,b=i.baseUrl;break;case 2:}a.extend(this,{downloadExcel:l,downloadPdf:m,uploadExcel:n,report:o})},a.fn.downloadExcel=function(b,c,d){var e=new g(b,c,d),f=new FormData(a(this)[0]);e.prepare(f)},a.fn.downloadPdf=function(b,c,d){d=d||{},d.contextUrl="pdf";var e=new g(b,c,d),f=new FormData(a(this)[0]);e.prepare(f)},a.fn.uploadExcel=function(b,c){1==arguments.length&&(c=b,b=null),b=b||{},b.contextUrl="upload";var d=new g("","",b),e=new FormData(a(this)[0]);d.prepare(e,c)},a.fn.excelReport=function(b,c,e){function f(a,b){var c=b.baseUrl||i.baseUrl,d=b.user,e=b.template,f=f,g=b.data,h=(b.callback,a.css("position"));f&&(e=e+"/"+f),"static"===h&&a.css("position","relative"),new flect.ExcelReport(c,d).report(a,e,g,b)}function g(b,c){var d={};if(b.find(":input").each(function(){var b=a(this),c=b.attr("name"),e=b.val(),f=d[c],g=typeof f;if("undefined"===g)d[c]=e;else if("string"===g){var h=[];h.push(f),h.push(e),d[c]=h}else f.push(e)}),!c){var e=[];for(var f in d){var g=d[f];if(a.isArray(g)){for(;g.length>0&&!g[g.length-1];)g.pop();0===g.length&&e.push(f)}else g||e.push(f)}for(var h=0;h<e.length;h++)delete d[e[h]]}return d}function h(b,c){var d={};return a.each(c,function(c,e){var f=b.find("#"+c);if(f.length)d[c]=e;else if(f=b.find("[data-name="+c+"]"),f.length)if(a.isArray(e)){var g=0;f.each(function(){var b=a(this),c=b.attr("id"),f=b.attr("data-formula");return f||(d[c]=e[g++]),g<e.length})}else{var h=a(f.get(0)).attr("id");d[h]=e}}),d}function j(b,c,e){var f=c,g=a.data(b.get(0),"connection");"string"==typeof c&&"undefined"!=typeof e&&(f={},f[c]=e),f=h(b,f),a.each(f,function(a,c){var e=b.find("#"+a);if(e.length){var f=e.find(":input");if(f.length)f.val(c);else{var g=e.find("span");g.text(c),d(""+c)&&!g.hasClass("cell-ac")&&g.removeClass("cell-al").addClass("cell-ar")}}}),g&&g.request({command:"updateCells",data:f})}switch("object"==typeof b&&(c=b,b="showExcel"),b){case"showExcel":return f(a(this),c),this;case"data":return g(a(this),!!c);case"updateCells":return j(a(this),c,e),this;default:throw"Unknown method: "+b}},a.excelReport=function(b,c){function d(b){"string"==typeof b&&(b={baseUrl:b}),b.msg&&(a.extend(h,b.msg),delete b.msg),a.extend(i,b)}function e(){throw"Not implemented yet"}function f(){throw"Not implemented yet"}switch("object"==typeof b&&(c=b,b="configure"),b){case"configure":d(c);break;case"downloadPdf":e(c);break;case"downloadExcel":f(c);break;default:throw"Unknown method: "+b}}}(jQuery);